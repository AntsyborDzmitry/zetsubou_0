{"version":3,"sources":["components/shipment/shipment-print/shipment-print-controller.js"],"names":[],"mappings":"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","file":"components/shipment/shipment-print/shipment-print-controller.js","sourcesContent":["import './shipment-print-service';\r\nimport './../../../services/modal/modal-service';\r\nimport PDFJS from 'pdfjs';\r\n\r\nShipmentPrintController.$inject = [\r\n    '$scope',\r\n    'modalService',\r\n    'logService',\r\n    'shipmentPrintService',\r\n    '$window',\r\n    '$q',\r\n    'navigationService',\r\n    'nlsService'\r\n];\r\n\r\n// TODO: wrong inject order\r\n// TODO: check all this file: controllers should not work with raw http response\r\nexport default function ShipmentPrintController(\r\n    $scope,\r\n    modalService,\r\n    logService,\r\n    shipmentPrintService,\r\n    $window,\r\n    $q,\r\n    navigationService,\r\n    nlsService) {\r\n    const vm = this;\r\n\r\n    $window.PDFJS = PDFJS || $window.PDFJS; // Workaround for PDFJS not exposing itself through the import variable\r\n                                            // TODO: remove this?\r\n\r\n    Object.assign(vm, {\r\n        previewDocument,\r\n        print,\r\n        saveAsFavorite,\r\n\r\n        waybillDocument: null,\r\n        receiptDocument: null,\r\n        invoiceDocument: null,\r\n\r\n        waybillQuantity: 1,\r\n        invoiceQuantity: 1,\r\n        receiptQuantity: 1,\r\n\r\n        pickUpDate: null,\r\n        pickUpNumber: null,\r\n        trackingNumber: null,\r\n\r\n        documents: {},\r\n        documentsAssigned: false,\r\n\r\n        DOCUMENT_TYPES: {\r\n            WAYBILL: 'WAYBILL_LABEL',\r\n            RECEIPT: 'RECEIPT',\r\n            INVOICE: 'INVOICE'\r\n        },\r\n\r\n        PATTERNS: {\r\n            numeric: '^(\\\\s*|\\\\d+)$'\r\n        },\r\n\r\n        //It will be used if the translation service is haven't given translation yet.\r\n        navigateAwayMessage: 'You haven\\'t printed your documents! Do you still want to navigate away from this page?'\r\n    });\r\n\r\n\r\n    const shipmentId = navigationService.getParamFromUrl('shipmentId');\r\n\r\n    $window.onbeforeunload = () => vm.navigateAwayMessage;\r\n\r\n    nlsService.getTranslation('shipment.navigating_without_printing')\r\n        .then((translation) => {\r\n            vm.navigateAwayMessage = translation;\r\n        });\r\n\r\n    shipmentPrintService.getDocumentsForPrinting(shipmentId)\r\n        .then((response) => {\r\n            if (response.data.documents.length) {\r\n                vm.documents = response.data.documents;\r\n                processDocuments();\r\n            } else {\r\n                vm.error = 'errors.print_service_receive_documents';\r\n            }\r\n        })\r\n        .catch((error) => {\r\n            vm.error = error;\r\n        });\r\n\r\n    //TODO: rewrite this when the real service will be available\r\n    shipmentPrintService.getTrackingNumber(shipmentId)\r\n        .then((trackingNumber) => {\r\n            if (trackingNumber) {\r\n                vm.trackingNumber = trackingNumber;\r\n            } else {\r\n                vm.error = 'errors.tracking_number_receive';\r\n            }\r\n        })\r\n        .catch(() => {\r\n            vm.error = 'errors.tracking_number_receive';\r\n        });\r\n\r\n    //TODO: rewrite this when the real service will be ready\r\n    shipmentPrintService.getPickUpInfo(shipmentId)\r\n        .then((response) => {\r\n            if (response) {\r\n                vm.pickUpDate = response.pickupDate;\r\n                vm.pickUpNumber = response.confirmationNumber;\r\n            } else {\r\n                vm.error = 'errors.pickup_info_receive';\r\n            }\r\n        });\r\n\r\n    function processDocuments() {\r\n        const waybillDocument = vm.documents.find((item) => item.documentType === vm.DOCUMENT_TYPES.WAYBILL);\r\n        if (waybillDocument) {\r\n            vm.waybillDocument = waybillDocument.pdfBase64;\r\n        }\r\n        const invoiceDocument = vm.documents.find((item) => item.documentType === vm.DOCUMENT_TYPES.INVOICE);\r\n        if (invoiceDocument) {\r\n            vm.invoiceDocument = invoiceDocument.pdfBase64;\r\n        }\r\n        const receiptDocument = vm.documents.find((item) => item.documentType === vm.DOCUMENT_TYPES.RECEIPT);\r\n        if (receiptDocument) {\r\n            vm.receiptDocument = receiptDocument.pdfBase64;\r\n        }\r\n\r\n        vm.documentsAssigned = true;\r\n    }\r\n\r\n    function previewDocument(docName) {\r\n\r\n        switch (docName) {\r\n            case vm.DOCUMENT_TYPES.WAYBILL:\r\n                $scope.previewedDocument = vm.waybillDocument;\r\n                break;\r\n            case vm.DOCUMENT_TYPES.RECEIPT:\r\n                $scope.previewedDocument = vm.receiptDocument;\r\n                break;\r\n            case vm.DOCUMENT_TYPES.INVOICE:\r\n                $scope.previewedDocument = vm.invoiceDocument;\r\n                break;\r\n        }\r\n\r\n        modalService.showDialog({\r\n            closeOnEsc: true,\r\n            scope: $scope,\r\n            windowClass: 'ngdialog-theme-default',\r\n            template:'<div ewf-modal><div class=ewf-modal__body><ewf-pdf pdf-document={{previewedDocument}}></ewf-pdf></div></div>'\r\n        });\r\n    }\r\n\r\n    function print() {\r\n\r\n        $window.onbeforeunload = null;\r\n\r\n        const pdfArrays = [];\r\n        const waybillPdfArray = pdfBase64ToArray(vm.waybillDocument);\r\n        pdfArrays.push(waybillPdfArray);\r\n\r\n        if (vm.invoiceDocument) {\r\n            const invoicePdfArray = pdfBase64ToArray(vm.invoiceDocument);\r\n            pdfArrays.push(invoicePdfArray);\r\n\r\n            for (let i = 1; i < vm.invoiceQuantity; i++) {\r\n                pdfArrays.push(invoicePdfArray);\r\n            }\r\n\r\n        }\r\n\r\n        for (let i = 1; i < vm.waybillQuantity; i++) {\r\n            pdfArrays.push(waybillPdfArray);\r\n        }\r\n\r\n        if (vm.printReceiptSelected) {\r\n            const receiptPdfArray = pdfBase64ToArray(vm.receiptDocument);\r\n\r\n            for (let i = 0; i < vm.receiptQuantity; i++) {\r\n                pdfArrays.push(receiptPdfArray);\r\n            }\r\n        }\r\n\r\n        const pagesContext = {\r\n            total: 0,\r\n            rendered: 0,\r\n            canvases: []\r\n        };\r\n\r\n        printPdfArrays(pdfArrays, pagesContext);\r\n\r\n    }\r\n\r\n    function pdfBase64ToArray(pdfBase64) {\r\n        const printingDocument = $window.atob(pdfBase64);\r\n        const arr = new Uint8Array(new ArrayBuffer(printingDocument.length));\r\n\r\n        for (let i = 0; i < printingDocument.length; i++) {\r\n            arr[i] = printingDocument.charCodeAt(i);\r\n        }\r\n\r\n        return arr;\r\n    }\r\n\r\n    function printPdfArrays(pdfArrays, pagesContext) {\r\n        $q.all(pdfArrays.map((pdfArr) => $window.PDFJS.getDocument(pdfArr)))\r\n            .then((pdfDocuments) => {\r\n\r\n                pdfDocuments.forEach((pdfDocument) => {\r\n                    pagesContext.total += pdfDocument.numPages;\r\n\r\n                    //TODO: refactor error handling here\r\n                    for (let i = 0; i < pdfDocument.numPages; i++) {\r\n                        pdfDocument.getPage(i + 1)\r\n                            .then(callRenderPage)\r\n                            .catch(fallBackDownloadPDFs);\r\n                    }\r\n                });\r\n\r\n                function callRenderPage(page) {\r\n                    renderPage(page, pagesContext);\r\n                }\r\n\r\n                function fallBackDownloadPDFs(error) {\r\n                    logService.error(error);\r\n                    vm.error = error;\r\n                    shipmentPrintService.downloadWaybillPdf();\r\n                    shipmentPrintService.downloadInvoicePdf();\r\n                    if (vm.printReceiptSelected) {\r\n                        shipmentPrintService.downloadReceiptPdf();\r\n                    }\r\n                    removeCanvases(pagesContext.canvases);\r\n                }\r\n\r\n            })\r\n            .catch((error) => {\r\n                logService.error(error);\r\n                vm.error = error;\r\n                shipmentPrintService.downloadWaybillPdf(shipmentId);\r\n                shipmentPrintService.downloadInvoicePdf(shipmentId);\r\n                if (vm.printReceiptSelected) {\r\n                    shipmentPrintService.downloadReceiptPdf(shipmentId);\r\n                }\r\n                removeCanvases(pagesContext.canvases);\r\n            });\r\n    }\r\n\r\n    function renderPage(page, pagesContext) {\r\n        const scale = 1.7;\r\n        const viewport = page.getViewport(scale);\r\n\r\n        const canvas = $window.document.createElement('canvas');\r\n        canvas.className = 'print';\r\n        $window.document.body.appendChild(canvas);\r\n        pagesContext.canvases.push(canvas);\r\n        const canvasContext = canvas.getContext('2d');\r\n        canvas.height = viewport.height;\r\n        canvas.width = viewport.width;\r\n\r\n        const renderContext = {canvasContext, viewport};\r\n\r\n        const pageRendering = page.render(renderContext);\r\n\r\n        const completeCallback = pageRendering._internalRenderTask.callback; //eslint-disable-line no-underscore-dangle\r\n        pageRendering._internalRenderTask.callback = function(error) { //eslint-disable-line no-underscore-dangle\r\n            completeCallback.call(this, error);\r\n            pagesContext.rendered++;\r\n            sendToPrinterIfReady(pagesContext);\r\n        };\r\n    }\r\n\r\n    function sendToPrinterIfReady(pagesContext) {\r\n        if (pagesContext.rendered === pagesContext.total) {\r\n            sendToPrinter(pagesContext);\r\n        }\r\n    }\r\n\r\n    function sendToPrinter(pagesContext) {\r\n        $window.setTimeout(() => {\r\n            $window.print();\r\n            $window.setTimeout(() => {\r\n                removeCanvases(pagesContext.canvases);\r\n                navigationService.location(`shipment-complete.html?shipmentId=${shipmentId}`);\r\n            }, 1);\r\n        }, 500);\r\n    }\r\n\r\n    function removeCanvases(canvases) {\r\n        canvases.forEach((canvas) => {\r\n            $window.document.body.removeChild(canvas);\r\n        });\r\n    }\r\n\r\n    function saveAsFavorite() {\r\n        shipmentPrintService.saveAsFavorite(shipmentId)\r\n            .then((response) => {\r\n                logService.log(response);\r\n            })\r\n            .catch((err) => {\r\n                logService.error(err);\r\n            });\r\n    }\r\n\r\n}\r\n"],"sourceRoot":"/source/"}